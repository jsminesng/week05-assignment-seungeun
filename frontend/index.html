<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supabase Todo App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              inter: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <!-- LLM Service -->
    <script src="./llmService.js"></script>
    <!-- Config (API Keys) -->
    <script>
      window.SUPABASE_CONFIG = {
        url: "https://isofapizsnpkglrvqvnd.supabase.co",
        key: "sb_publishable_ZkTRJoBig3qJneYG2xwrXw_-CMlfr3b",
      };
    </script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      // üîê Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉùÏÑ± (config.jsÏóêÏÑú ÏÑ§Ï†ï Í∞ÄÏ†∏Ïò§Í∏∞)
      const supabase = window.supabase.createClient(
        window.SUPABASE_CONFIG.url,
        window.SUPABASE_CONFIG.key
      );

      // ============================================
      // üîê Ïù∏Ï¶ù Ïª¥Ìè¨ÎÑåÌä∏ (Î°úÍ∑∏Ïù∏/ÌöåÏõêÍ∞ÄÏûÖ)
      // ============================================
      function AuthApp() {
        const [isLogin, setIsLogin] = React.useState(true);
        const [email, setEmail] = React.useState("");
        const [password, setPassword] = React.useState("");
        const [loading, setLoading] = React.useState(false);
        const [message, setMessage] = React.useState("");

        async function handleAuth(e) {
          e.preventDefault();
          setLoading(true);
          setMessage("");

          try {
            if (isLogin) {
              // Î°úÍ∑∏Ïù∏
              const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password,
              });
              if (error) throw error;
              setMessage("Sign in successful! üéâ");
            } else {
              // ÌöåÏõêÍ∞ÄÏûÖ
              const { data, error } = await supabase.auth.signUp({
                email,
                password,
              });
              if (error) throw error;
              setMessage("Sign up successful! Please check your email. ‚úâÔ∏è");
            }
          } catch (error) {
            setMessage(error.message);
          } finally {
            setLoading(false);
          }
        }

        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden w-full max-w-md">
              {/* Ìó§Îçî */}
              <div className="bg-white border-b border-gray-200 p-8 text-center">
                <div className="flex items-center justify-center mb-4">
                  <div className="w-12 h-12 bg-gray-900 rounded-full flex items-center justify-center">
                    <svg
                      className="w-6 h-6 text-white"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                      />
                    </svg>
                  </div>
                </div>
                <h1 className="text-2xl font-inter font-semibold text-gray-900 mb-1 tracking-tight">
                  {isLogin ? "Sign In" : "Sign Up"}
                </h1>
                <p className="text-sm text-gray-500">
                  {isLogin ? "Sign in to your account" : "Create a new account"}
                </p>
              </div>

              {/* Ìèº */}
              <div className="p-8">
                <form onSubmit={handleAuth} className="space-y-5">
                  {/* Ïù¥Î©îÏùº */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Email
                    </label>
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      placeholder="your@email.com"
                      required
                      className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-gray-900 outline-none transition text-gray-900 placeholder-gray-400"
                    />
                  </div>

                  {/* ÎπÑÎ∞ÄÎ≤àÌò∏ */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Password
                    </label>
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      placeholder="Minimum 6 characters"
                      required
                      minLength={6}
                      className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-gray-900 outline-none transition text-gray-900 placeholder-gray-400"
                    />
                  </div>

                  {/* Î©îÏãúÏßÄ */}
                  {message && (
                    <div
                      className={`p-3 rounded-lg text-sm ${
                        message.includes("success") ||
                        message.includes("Success")
                          ? "bg-green-50 text-green-700 border border-green-200"
                          : "bg-red-50 text-red-700 border border-red-200"
                      }`}
                    >
                      {message}
                    </div>
                  )}

                  {/* Î°úÍ∑∏Ïù∏/ÌöåÏõêÍ∞ÄÏûÖ Î≤ÑÌäº */}
                  <button
                    type="submit"
                    disabled={loading}
                    className="w-full bg-gray-900 text-white font-medium py-2.5 rounded-lg hover:bg-gray-800 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {loading
                      ? "Processing..."
                      : isLogin
                      ? "Sign In"
                      : "Sign Up"}
                  </button>
                </form>

                {/* Ï†ÑÌôò Î≤ÑÌäº */}
                <div className="mt-6 text-center">
                  <button
                    onClick={() => {
                      setIsLogin(!isLogin);
                      setMessage("");
                      setEmail("");
                      setPassword("");
                    }}
                    className="text-sm text-gray-600 hover:text-gray-900 transition-colors"
                  >
                    {isLogin
                      ? "Don't have an account? Sign Up"
                      : "Already have an account? Sign In"}
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // ============================================
      // üìù Todo Ïï± Ïª¥Ìè¨ÎÑåÌä∏
      // ============================================
      function TodoApp({ user, onLogout }) {
        const [todos, setTodos] = React.useState([]);
        const [inputText, setInputText] = React.useState("");

        // AI Todo Breakdown ÏÉÅÌÉú
        const [aiTaskInput, setAiTaskInput] = React.useState("");
        const [aiSteps, setAiSteps] = React.useState([]);
        const [selectedSteps, setSelectedSteps] = React.useState([]);
        const [isAiLoading, setIsAiLoading] = React.useState(false);
        const [showAiSection, setShowAiSection] = React.useState(false);

        // üìå Ï≤òÏùå Î°úÎî© Ïãú DBÏóêÏÑú todos Î∂àÎü¨Ïò§Í∏∞
        React.useEffect(() => {
          loadTodos();
        }, []);

        async function loadTodos() {
          const { data, error } = await supabase
            .from("todos")
            .select("*")
            .eq("user_id", user.id); // ÏûêÍ∏∞ Í≤ÉÎßå Í∞ÄÏ†∏Ïò§Í∏∞
          if (!error) setTodos(data);
        }

        async function addTodo(text) {
          if (!text.trim()) return;
          const { data, error } = await supabase
            .from("todos")
            .insert([{ text, completed: false, user_id: user.id }]) // Ïó¨Í∏∞ Ï§ëÏöî!
            .select();
          if (!error && data) {
            setTodos([data[0], ...todos]);
            setInputText("");
          }
        }

        // üìå Todo ÏôÑÎ£å ÌÜ†Í∏Ä
        async function toggleTodo(todo) {
          const { data, error } = await supabase
            .from("todos")
            .update({ completed: !todo.completed })
            .eq("id", todo.id)
            .eq("user_id", user.id) // Î≥∏Ïù∏Ïùò TodoÎßå ÏàòÏ†ï Í∞ÄÎä•ÌïòÎèÑÎ°ù
            .select();
          if (error) {
            console.error("ÏàòÏ†ï Ïã§Ìå®:", error);
          } else {
            setTodos(todos.map((t) => (t.id === todo.id ? data[0] : t)));
          }
        }

        // üìå Todo ÏÇ≠Ï†ú
        async function deleteTodo(id) {
          const { error } = await supabase
            .from("todos")
            .delete()
            .eq("id", id)
            .eq("user_id", user.id); // Î≥∏Ïù∏Ïùò TodoÎßå ÏÇ≠Ï†ú Í∞ÄÎä•ÌïòÎèÑÎ°ù
          if (error) {
            console.error("ÏÇ≠Ï†ú Ïã§Ìå®:", error);
          } else {
            setTodos(todos.filter((t) => t.id !== id));
          }
        }

        // üìå Ï†ÑÏ≤¥ Todo ÏÇ≠Ï†ú
        async function deleteAllTodos() {
          if (todos.length === 0) return;

          const confirmed = window.confirm(
            `Are you sure you want to delete all ${todos.length} todos?\nThis action cannot be undone.`
          );

          if (!confirmed) return;

          const { error } = await supabase
            .from("todos")
            .delete()
            .eq("user_id", user.id); // Î≥∏Ïù∏Ïùò Î™®Îì† Todo ÏÇ≠Ï†ú

          if (error) {
            console.error("Ï†ÑÏ≤¥ ÏÇ≠Ï†ú Ïã§Ìå®:", error);
            alert("An error occurred while deleting all todos.");
          } else {
            setTodos([]);
            alert("All todos have been deleted successfully.");
          }
        }

        // Î°úÍ∑∏ÏïÑÏõÉ
        async function handleLogout() {
          await supabase.auth.signOut();
          onLogout();
        }

        // ü§ñ AI Todo Breakdown Ìï®ÏàòÎì§
        async function handleAIBreakdown() {
          const task = aiTaskInput.trim();

          if (!task) {
            alert("ÌÅ∞ ÏûëÏóÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!");
            return;
          }

          setIsAiLoading(true);
          setAiSteps([]);
          setSelectedSteps([]);

          try {
            console.log("ü§ñ AI ÏöîÏ≤≠ ÏãúÏûë:", task);

            // LLMServiceÎ•º ÏÇ¨Ïö©ÌïòÏó¨ AI ÏöîÏ≤≠
            const text = await LLMService.generate(task);
            console.log("‚úÖ AI ÏùëÎãµ Î∞õÏùå:", text);

            const steps = LLMService._parseSteps(text);
            setAiSteps(steps);
            setShowAiSection(true);
          } catch (error) {
            console.error("‚ùå AI ÏöîÏ≤≠ Ïã§Ìå®:", error);

            let message = "AI ÏöîÏ≤≠ Ïã§Ìå®";
            if (error.message.includes("connect")) {
              message =
                "Express ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§. ÏÑúÎ≤ÑÍ∞Ä Ïã§Ìñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî.";
            } else if (error.message.includes("API")) {
              message = "API ÌÇ§ Ïò§Î•òÏûÖÎãàÎã§. .env ÌååÏùºÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.";
            } else if (error.message.includes("Too many")) {
              message = "ÏöîÏ≤≠Ïù¥ ÎÑàÎ¨¥ ÎßéÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.";
            }

            alert(message);
          } finally {
            setIsAiLoading(false);
          }
        }

        // AI Îã®Í≥Ñ ÏÑ†ÌÉù/Ìï¥Ï†ú
        function toggleStepSelection(index) {
          setSelectedSteps((prev) =>
            prev.includes(index)
              ? prev.filter((i) => i !== index)
              : [...prev, index]
          );
        }

        // ÏÑ†ÌÉùÌïú Îã®Í≥ÑÎì§ÏùÑ TodoÏóê Ï∂îÍ∞Ä
        async function addSelectedStepsToTodos() {
          const stepsToAdd = selectedSteps.map((index) => aiSteps[index]);

          if (stepsToAdd.length === 0) {
            alert("Ï∂îÍ∞ÄÌï† Îã®Í≥ÑÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!");
            return;
          }

          try {
            for (const step of stepsToAdd) {
              await addTodo(step);
            }

            // AI ÏÑπÏÖò Ï¥àÍ∏∞Ìôî
            setAiSteps([]);
            setSelectedSteps([]);
            setAiTaskInput("");
            setShowAiSection(false);

            alert(`${stepsToAdd.length}Í∞úÏùò Îã®Í≥ÑÍ∞Ä TodoÏóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!`);
          } catch (error) {
            console.error("Todo Ï∂îÍ∞Ä Ïã§Ìå®:", error);
            alert("Todo Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
          }
        }

        // ÌÜµÍ≥Ñ
        const total = todos.length;
        const completed = todos.filter((t) => t.completed).length;
        const remaining = total - completed;

        return (
          <div className="min-h-screen bg-gray-50 p-6">
            <div className="max-w-2xl mx-auto">
              {/* Ìó§Îçî */}
              <header className="mb-8">
                <div className="flex items-center justify-between mb-6">
                  <div className="flex-1"></div>
                  <div className="flex-1 text-center">
                    <h1 className="text-4xl font-inter font-semibold text-gray-900 tracking-tight">
                      TodoList
                    </h1>
                  </div>
                  <div className="flex-1 flex flex-col items-end">
                    <button
                      onClick={handleLogout}
                      className="text-sm text-gray-600 hover:text-gray-900 px-4 py-2 rounded-lg border border-gray-300 hover:border-gray-900 transition-colors"
                    >
                      Logout
                    </button>
                  </div>
                </div>
              </header>

              {/* AI Todo Breakdown */}
              <div className="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl border border-purple-200 p-6 mb-6">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-sm font-medium text-purple-700">
                    ü§ñ AI Todo Breakdown
                  </h2>
                  <button
                    onClick={() => setShowAiSection(!showAiSection)}
                    className="text-xs text-purple-600 hover:text-purple-700 px-3 py-1 rounded-md border border-purple-200 hover:border-purple-300 transition-colors"
                  >
                    {showAiSection ? "Hide" : "Show"}
                  </button>
                </div>

                <div className="space-y-4">
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={aiTaskInput}
                      onChange={(e) => setAiTaskInput(e.target.value)}
                      onKeyDown={(e) => {
                        if (e.key === "Enter") handleAIBreakdown();
                      }}
                      placeholder="Enter a big task (e.g., 'Build a blog with React and Supabase')..."
                      className="flex-1 px-4 py-2.5 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none text-gray-900 placeholder-gray-400"
                    />
                    <button
                      onClick={handleAIBreakdown}
                      disabled={isAiLoading || !aiTaskInput.trim()}
                      className="bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-6 py-2.5 rounded-lg font-medium transition-colors"
                    >
                      {isAiLoading ? "ü§ñ AI Thinking..." : "Break Down"}
                    </button>
                  </div>

                  {showAiSection && aiSteps.length > 0 && (
                    <div className="bg-white rounded-lg border border-purple-200 p-4">
                      <div className="flex items-center justify-between mb-3">
                        <h3 className="text-sm font-medium text-gray-700">
                          AI Generated Steps ({aiSteps.length})
                        </h3>
                        <button
                          onClick={addSelectedStepsToTodos}
                          disabled={selectedSteps.length === 0}
                          className="text-xs bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-3 py-1 rounded-md transition-colors"
                        >
                          Add Selected ({selectedSteps.length})
                        </button>
                      </div>
                      <div className="space-y-2">
                        {aiSteps.map((step, index) => (
                          <div
                            key={index}
                            className={`flex items-center gap-3 p-2 rounded-lg cursor-pointer transition-colors ${
                              selectedSteps.includes(index)
                                ? "bg-purple-100 border border-purple-300"
                                : "hover:bg-gray-50"
                            }`}
                            onClick={() => toggleStepSelection(index)}
                          >
                            <input
                              type="checkbox"
                              checked={selectedSteps.includes(index)}
                              onChange={() => toggleStepSelection(index)}
                              className="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500 cursor-pointer"
                            />
                            <span className="flex-1 text-sm text-gray-700">
                              {step}
                            </span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              </div>

              {/* Todo Ï∂îÍ∞Ä */}
              <div className="bg-white rounded-xl border border-gray-200 p-6 mb-6">
                <h2 className="text-sm font-medium text-gray-700 mb-3">
                  Add New Todo
                </h2>
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={inputText}
                    onChange={(e) => setInputText(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === "Enter") addTodo(inputText);
                    }}
                    placeholder="Enter a todo..."
                    className="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-gray-900 outline-none text-gray-900 placeholder-gray-400"
                  />
                  <button
                    onClick={() => addTodo(inputText)}
                    className="bg-gray-900 hover:bg-gray-800 text-white px-6 py-2.5 rounded-lg font-medium transition-colors"
                  >
                    Add
                  </button>
                </div>
              </div>

              {/* Todo Î™©Î°ù */}
              <div className="bg-white rounded-xl border border-gray-200 p-6">
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center gap-3">
                    <h2 className="text-sm font-medium text-gray-700">
                      Todo List
                    </h2>
                    <span className="text-xs text-gray-500">
                      {todos.length} items
                    </span>
                  </div>
                  {todos.length > 0 && (
                    <button
                      onClick={deleteAllTodos}
                      className="text-xs text-red-500 hover:text-red-700 px-3 py-1 rounded-md border border-red-200 hover:border-red-300 transition-colors"
                    >
                      Delete All
                    </button>
                  )}
                </div>
                {todos.length === 0 ? (
                  <div className="text-center py-12">
                    <div className="text-gray-300 mb-2">
                      <svg
                        className="w-12 h-12 mx-auto"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={1.5}
                          d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                        />
                      </svg>
                    </div>
                    <p className="text-gray-400 text-sm">No todos yet</p>
                  </div>
                ) : (
                  <div className="space-y-2">
                    {todos.map((todo) => (
                      <div
                        key={todo.id}
                        className="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors group"
                      >
                        <input
                          type="checkbox"
                          checked={todo.completed}
                          onChange={() => toggleTodo(todo)}
                          className="w-4 h-4 text-gray-900 border-gray-300 rounded focus:ring-gray-900 cursor-pointer"
                        />
                        <span
                          className={`flex-1 text-sm ${
                            todo.completed
                              ? "line-through text-gray-400"
                              : "text-gray-700"
                          }`}
                        >
                          {todo.text}
                        </span>
                        <button
                          onClick={() => deleteTodo(todo.id)}
                          className="text-gray-400 hover:text-gray-900 opacity-0 group-hover:opacity-100 transition-opacity"
                        >
                          <svg
                            className="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                            />
                          </svg>
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* ÌÜµÍ≥Ñ */}
              <div className="bg-white rounded-xl border border-gray-200 p-6 mt-6">
                <h3 className="text-sm font-medium text-gray-700 mb-4">
                  Progress
                </h3>
                <div className="grid grid-cols-3 gap-4">
                  <div className="text-center">
                    <div className="text-2xl font-semibold text-gray-900 mb-1">
                      {total}
                    </div>
                    <div className="text-xs text-gray-500">Total</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-semibold text-gray-900 mb-1">
                      {completed}
                    </div>
                    <div className="text-xs text-gray-500">Completed</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-semibold text-gray-900 mb-1">
                      {remaining}
                    </div>
                    <div className="text-xs text-gray-500">Remaining</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // ============================================
      // üéØ Î©îÏù∏ Ïï± Ïª¥Ìè¨ÎÑåÌä∏
      // ============================================
      function App() {
        const [user, setUser] = React.useState(null);
        const [loading, setLoading] = React.useState(true);

        React.useEffect(() => {
          // ÌòÑÏû¨ ÏÑ∏ÏÖò ÌôïÏù∏
          supabase.auth.getSession().then(({ data: { session } }) => {
            setUser(session?.user ?? null);
            setLoading(false);
          });

          // Ïù∏Ï¶ù ÏÉÅÌÉú Î≥ÄÌôî Í∞êÏßÄ
          const {
            data: { subscription },
          } = supabase.auth.onAuthStateChange((_event, session) => {
            setUser(session?.user ?? null);
          });

          return () => subscription.unsubscribe();
        }, []);

        if (loading) {
          return (
            <div className="min-h-screen flex items-center justify-center">
              <div className="text-2xl font-bold text-blue-600">Loading...</div>
            </div>
          );
        }

        return user ? (
          <TodoApp user={user} onLogout={() => setUser(null)} />
        ) : (
          <AuthApp />
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
